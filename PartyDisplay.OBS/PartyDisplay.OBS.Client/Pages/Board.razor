@page "/board"
@rendermode InteractiveWebAssembly
@using Microsoft.AspNetCore.SignalR.Client
@using PartyDisplay.OBS.Lib.Xfer
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Board Info</PageTitle>

<div class="game-frame"><img class="game-img" src="@_gameImg" alt="@_game"/></div>
<div class="board-frame"><img class="board-img" src="@_boardImg" alt="@_board"/></div>
<p class="turn-count">Turn @_turnCount / @_turnLimit</p>
@if (GameAbr == "mp6" || (GameAbr == "mp2" && _board == "Horror Land")) {
    // TODO: Insert Day/Night Cycle State & Counter
    <p>Insert Day/Night Cycle Here</p>
}
@if (GameAbr == "mp7") {
    // TODO: Insert Bowser Time Counter
    <p>Insert Bowser Time Here</p>
}

@code {
    private HubConnection? _hubConnection;
    private string? _game;
    private string? _gameImg;
    private string? _board;
    private string? _boardImg;
    private short _turnCount = 0;
    private short _turnLimit = 0;
    
    private string? GameAbr => _game switch {
        "Mario Party 2" => "mp2",
        "Mario Party 4" => "mp4",
        "Mario Party 5" => "mp5",
        "Mario Party 6" => "mp6",
        "Mario Party 7" => "mp7",
        "Mario Party 8" => "mp8",
        _ => _game
    };
    private string? BoardNormalized => _board?.Trim()
        .ToLower()
        .Replace(' ', '_')
        .Replace("\'", "")
        .Replace(".", "")
        .Replace("!", "");

    protected override async Task OnInitializedAsync() {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/hub/board"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<string>("SetGame", (game) => {
            _game = game;
            _gameImg = GameAbr == game ? "" : $"/img/title/{GameAbr}.png";
            InvokeAsync(StateHasChanged);
        });
        
        _hubConnection.On<string>("SetName", (name) => {
            _board = name;
            _boardImg = $"/img/board/{GameAbr}.{BoardNormalized}.logo.png";
            InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<short>("SetTurnCurrent", (turn) => {
            _turnCount = turn;
            InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<short>("SetTurnLimit", (limit) => {
            _turnLimit = limit;
            InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
    }

    public bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync() {
        if (_hubConnection is not null) {
            await _hubConnection.DisposeAsync();
        }
    }
}